name: Update Gallery JSON

on:
  push:
    paths:
      - "gallery/**"     # Trigger when images are added/removed/changed
  workflow_dispatch:     # Allow manual trigger

jobs:
  update-gallery:
    runs-on: ubuntu-latest
    steps:
      # 1. Checkout repository
      - uses: actions/checkout@v4

      # 2. Generate gallery.json from /gallery/YYYY/MM/DD folders
      - name: Generate gallery.json
        run: |
          echo "{" > gallery.json
          for year in gallery/*; do
            [ -d "$year" ] || continue
            yname=$(basename "$year")
            echo "  \"$yname\": {" >> gallery.json

            for month in "$year"/*; do
              [ -d "$month" ] || continue
              mname=$(basename "$month")
              echo "    \"$mname\": {" >> gallery.json

              for day in "$month"/*; do
                [ -d "$day" ] || continue
                dname=$(basename "$day")
                echo "      \"$dname\": [" >> gallery.json

                # Loop through image files
                find "$day" -type f \( -iname "*.jpg" -o -iname "*.jpeg" -o -iname "*.png" -o -iname "*.webp" \) | sort | while read file; do
                  url="https://raw.githubusercontent.com/${{ github.repository }}/main/$file"
                  echo "        \"$url\"," >> gallery.json
                done

                # Remove last comma
                sed -i '$ s/,$//' gallery.json
                echo "      ]," >> gallery.json
              done

              # Remove trailing comma for month
              sed -i '$ s/,$//' gallery.json
              echo "    }," >> gallery.json
            done

            # Remove trailing comma for year
            sed -i '$ s/,$//' gallery.json
            echo "  }," >> gallery.json
          done

          # Remove last comma and close JSON
          sed -i '$ s/,$//' gallery.json
          echo "}" >> gallery.json

      # 3. Commit and push changes using PAT
      - name: Commit and push
        env:
          PAT_TOKEN: ${{ secrets.PAT_TOKEN }}   # Use the PAT stored in repo secrets
        run: |
          git config --global user.name "Biraj Rai"
          git config --global user.email "70630924+birajrai@users.noreply.github.com"
          git add gallery.json
          git diff-index --quiet HEAD || git commit -m "Auto-update gallery.json"
          git push https://$PAT_TOKEN@github.com/meropatra/janaprabhat-gallery.git HEAD:main
